<!--
Codes Generated By VForm:
https://www.vform666.com
-->

<template>
  <el-row class="my-5">
    <el-col :span="6" :offset="9" class="grid-cell">
      <el-form :model="changePwdForm" ref="vChangePwdForm" :rules="rules" label-position="top" label-width="80px"
               size="default" @submit.prevent>
        <div class="flex justify-center">
          <el-form-item>
            <ImageUpload :imageUrl="changePwdForm.avatarInput" @imageChanged="imageChanged">
            </ImageUpload>
          </el-form-item>
        </div>
        <el-form-item label="用户昵称" prop="nickName" class="required">
          <el-input v-model="changePwdForm.nickName" type="text" clearable></el-input>
        </el-form-item>
        <div class="static-content-item flex justify-center">
          <el-button type="primary" @click="submitForm">提交</el-button>
        </div>
      </el-form>
    </el-col>
  </el-row>

</template>

<script>
import {
  defineComponent,
  toRefs,
  reactive,
  getCurrentInstance
}
  from 'vue'
import {ElMessage} from "element-plus";
import {userUserStore} from "../../store/modules/user";
import ImageUpload from "../../components/imageUpload.vue";
import {api} from "../../request";

export default defineComponent({
  name: 'userInfo',
  components: {ImageUpload, fileUpload: ImageUpload},
  props: {},
  setup() {
    const currentUser = userUserStore.currentUser;
    const state = reactive({
      changePwdForm: {
        avatarInput: currentUser.avatar,
        nickName: currentUser.nickName,
      },
      rules: {
        avatar: [{
          required: true,
          message: '字段值不可为空',
        }],
        nickName: [{
          required: true,
          message: '字段值不可为空',
        }],
      },
    })
    const instance = getCurrentInstance()
    const submitForm = () => {
      instance.ctx.$refs['vChangePwdForm'].validate(async valid => {
        if (!valid) return
        await api.AuthWriteControllerApi.updateCurrentUserInfo(undefined,
            {
              nickName: state.changePwdForm.nickName,
              avatar: state.changePwdForm.avatarInput
            })
        userUserStore.updateInfo(state.changePwdForm.nickName, state.changePwdForm.avatarInput)
        ElMessage.success('修改成功')
      })
    }
    const resetForm = () => {
      instance.ctx.$refs['vChangePwdForm'].resetFields()
    }
    const imageChanged = (e) => {
      console.log(e)
      state.changePwdForm.avatarInput = e
    }
    return {
      ...toRefs(state),
      submitForm,
      resetForm,
      imageChanged
    }

  }
})

</script>

<style lang="less" scoped>
div.table-container {
  table.table-layout {
    width: 100%;
    table-layout: fixed;
    border-collapse: collapse;

    td.table-cell {
      display: table-cell;
      height: 36px;
      border: 1px solid #e1e2e3;
    }
  }
}

div.tab-container {
}

.label-left-align :deep(.el-form-item__label) {
  text-align: left;
}

.label-center-align :deep(.el-form-item__label) {
  text-align: center;
}

.label-right-align :deep(.el-form-item__label) {
  text-align: right;
}

.custom-label {
}

.static-content-item {
  min-height: 20px;
  display: flex;
  align-items: center;

  :deep(.el-divider--horizontal) {
    margin: 0;
  }
}

</style>